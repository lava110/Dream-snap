<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSnap - AI æ¢ç´¢å®éªŒå®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* --- é«˜ä¿çœŸæ ·å¼ç³»ç»Ÿ --- */
        :root {
            --primary: #FF6B6B;
            --primary-hover: #FF5252;
            --secondary: #4ECDC4;
            --bg: #F0F4F8; /* æ›´æŸ”å’Œçš„èƒŒæ™¯ç° */
            --card-bg: #FFFFFF;
            --text-main: #2D3436;
            --text-sub: #636E72;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 15px 35px rgba(0,0,0,0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            background: var(--card-bg);
            border-radius: 30px;
            box-shadow: var(--shadow-lg);
            padding: 40px;
            box-sizing: border-box;
        }

        /* æ ‡é¢˜åŒº */
        h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #FF6B6B, #FF9F43);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0 0 10px 0;
            text-align: center;
            letter-spacing: -1px;
        }
        .subtitle { text-align: center; color: var(--text-sub); margin-bottom: 30px; }

        /* å¯¼èˆªæ ‡ç­¾ - æ¨¡ä»¿èƒ¶å›Šæ ·å¼ */
        .tabs {
            display: inline-flex;
            background: #F1F2F6;
            padding: 6px;
            border-radius: 50px;
            margin: 0 auto 40px auto;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 10px 25px;
            border: none;
            background: transparent;
            border-radius: 40px;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        .tab-btn.active {
            background: var(--card-bg);
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        /* å¸ƒå±€ */
        .workspace {
            display: flex;
            gap: 50px;
            align-items: flex-start;
        }
        .panel-left { flex: 1; min-width: 320px; }
        .panel-right { 
            flex: 1.4; 
            position: sticky; 
            top: 20px; 
            background: var(--card-bg); 
            z-index: 10;
            padding-bottom: 20px;
        }

        @media (max-width: 850px) {
            .workspace { flex-direction: column; }
            .panel-right { position: static; width: 100%; }
            .container { padding: 20px; }
        }

        /* æ§åˆ¶é¡¹å¡ç‰‡åŒ– */
        .control-group {
            margin-bottom: 20px;
            background: #FFFFFF;
            /* ç¨å¾®åŠ ä¸€ç‚¹è¾¹æ¡†è®©å®ƒæ›´æ¸…æ™° */
            border: 1px solid #EEE;
            border-radius: 16px;
            padding: 15px 20px;
            transition: transform 0.2s;
        }
        .control-group:hover { border-color: #DDD; }

        .control-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- ğŸ¨ é«˜çº§ UI ç»„ä»¶å¤åˆ» --- */

        /* 1. ä¸‹æ‹‰æ¡† Select */
        select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid #F1F2F6;
            background-color: #FAFBFC;
            font-size: 1rem;
            color: #2D3436;
            font-weight: 500;
            outline: none;
            transition: border-color 0.2s;
            cursor: pointer;
        }
        select:focus { border-color: var(--secondary); background: #FFF; }

        /* 2. ç°ä»£åŒ–æ»‘å— Range Slider (é‡ç‚¹ä¼˜åŒ–) */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 10px 0;
        }
        input[type=range]:focus { outline: none; }
        
        /* æ»‘è½¨ */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #DFE6E9;
            border-radius: 5px;
        }
        /* æ»‘å—å¤´ */
        input[type=range]::-webkit-slider-thumb {
            height: 22px;
            width: 22px;
            border-radius: 50%;
            background: var(--secondary);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px; /* å±…ä¸­ */
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            border: 2px solid #FFF;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* 3. é­”æ³•æŒ‰é’® Button */
        .magic-btn {
            width: 100%;
            border: none;
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 16px;
            border-radius: 16px;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .magic-btn:active { transform: scale(0.96); box-shadow: 0 5px 10px rgba(255, 107, 107, 0.3); }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .copy-btn { background: #74B9FF; margin-right: 10px; }
        .download-btn { background: #00CEC9; }
        .optimize-btn { background: #a29bfe; width: 100%; margin-top: 12px; padding: 14px; border:none; border-radius:14px; color:white; font-weight:bold; cursor:pointer;}
        .save-btn { background: #ff7675; width: 100%; margin-top: 10px; padding: 14px; border:none; border-radius:14px; color:white; font-weight:bold; cursor:pointer;}

        /* 4. å–æ™¯å™¨ä¸é»‘æ¡† */
        .viewfinder {
            width: 100%;
            aspect-ratio: 3/2;
            background: #2d3436;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow-md);
            border: 4px solid #FFF;
        }
        .viewfinder img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; }
        
        .output-box {
            background: #1e272e; /* æ›´æ·±é‚ƒçš„é»‘ */
            color: #dfe6e9;
            padding: 20px;
            border-radius: 16px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.95rem;
            line-height: 1.8; /* æ›´å¤§çš„è¡Œé«˜ */
            margin-top: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            border: 1px solid #353b48;
            min-height: 100px;
        }

        /* 5. å½©è™¹è¯­æ³•é«˜äº® (é²œè‰³ç‰ˆ) */
        .token-style { color: #ff7675; font-weight:bold; } 
        .token-subject { color: #74b9ff; font-weight:bold; } 
        .token-emotion { color: #a29bfe; font-weight:bold; } 
        .token-env { color: #fd79a8; font-weight:bold; } 
        .token-zoom { color: #55efc4; font-weight:bold; } 
        .token-base { color: #b2bec3; font-size: 0.9em; }

        /* ä»»åŠ¡æ¿ */
        #mission-board {
            background: #fff3cd;
            border: 2px solid #ffeeba;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* è¾…åŠ©åŠ¨ç”» */
        .spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; background: rgba(0,0,0,0.8); padding: 12px 24px; border-radius: 30px; display: none; font-weight:bold; backdrop-filter: blur(5px); }
        .mode-content { display: none; animation: fadeIn 0.4s; }
        .mode-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç”»å»Š */
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 30px; }
        .gallery-card { height: 150px; perspective: 1000px; cursor: pointer; }
        .card-inner { width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 15px; box-shadow: var(--shadow-sm); position: relative; }
        .gallery-card:hover .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 15px; overflow: hidden; }
        .card-front img { width: 100%; height: 100%; object-fit: cover; }
        .card-back { background: #2D3436; color: #81ECEC; transform: rotateY(180deg); display: flex; align-items: center; justify-content: center; padding: 10px; font-size: 0.7rem; overflow: hidden; }

    </style>
</head>
<body>

<div class="container">
    <h1>âœ¨ DreamSnap</h1>
    <p class="subtitle">å¯è§†åŒ–çš„ AI é€»è¾‘å®éªŒå®¤</p>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('auto')">ğŸ² è‡ªåŠ¨é€ æ¢¦</button>
        <button class="tab-btn" onclick="switchTab('manual')">ğŸ› ï¸ äººå·¥å®éªŒå®¤</button>
        <button class="tab-btn" onclick="switchTab('challenge')">ğŸ† æŒ‘æˆ˜ä»»åŠ¡</button>
    </div>

    <div class="workspace">
        <div class="panel-left">
            
            <div id="auto-mode" class="mode-content active">
                <div class="control-group" style="text-align:center; border:none; background:transparent; padding-top:60px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ²</div>
                    <p style="color:#636E72; line-height:1.6;">ç‚¹å‡»é­”æ³•æŒ‰é’®<br>éšæœºç”Ÿæˆæ— é™çµæ„Ÿ</p>
                    <button class="magic-btn" onclick="generateAutoPrompt()">âœ¨ ç«‹å³é€ æ¢¦</button>
                </div>
            </div>

            <div id="manual-mode" class="mode-content">
                
                <div id="mission-board" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h3 style="margin:0; color:#856404; font-size:1.1rem;">ğŸš© <span id="level-title">Level 1</span></h3>
                        <span style="background:#FFC107; padding:4px 10px; border-radius:20px; font-size:0.75rem; font-weight:bold;">è¿›è¡Œä¸­</span>
                    </div>
                    <p id="mission-desc" style="color:#856404; font-size:0.95rem; margin-bottom:15px; line-height:1.5;">åŠ è½½ä¸­...</p>
                    <ul id="mission-checklist" style="padding-left:0; list-style:none; font-size:0.9rem; background:rgba(255,255,255,0.5); padding:10px; border-radius:10px;"></ul>
                    <button id="next-level-btn" onclick="nextLevel()" style="display:none; width:100%; background:#2ecc71; color:white; border:none; padding:12px; border-radius:12px; margin-top:15px; font-weight:bold; cursor:pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);">ğŸ‰ æŒ‘æˆ˜æˆåŠŸï¼è¿›å…¥ä¸‹ä¸€å…³</button>
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸ‘¤ ä¸»è§’ (Subject)</label>
                    <select id="subject-select" onchange="handleUpdate()">
                        <option value="girl">ğŸ‘©â€ğŸ¤ èµ›åšå°‘å¥³</option>
                        <option value="cat">ğŸ± å®‡èˆªå‘˜çŒ«å’ª</option>
                        <option value="warrior">âš”ï¸ å¤ä»£å‰‘å®¢</option>
                        <option value="robot">ğŸ¤– å¤å¤æœºå™¨äºº</option>
                        <option value="wizard">ğŸ§™â€â™‚ï¸ é­”æ³•å¸ˆ</option>
                        <option value="house">ğŸ  éœæ¯”ç‰¹å°å±‹</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸ˜Š æƒ…ç»ª (Emotion)</label>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:1.2rem; color:#B2BEC3;">
                        <span>ğŸ˜¢</span><span>ğŸ˜</span><span>ğŸ˜†</span><span>ğŸ˜¡</span><span>ğŸ˜²</span>
                    </div>
                    <input type="range" id="emotion-slider" min="0" max="4" step="1" value="1" oninput="handleUpdate()">
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸ¨ é£æ ¼ (Style)</label>
                    <select id="style-select" onchange="handleUpdate()">
                        <option value="real">ğŸ“± æ‰‹æœºæŠ“æ‹ (Real)</option>
                        <option value="cinema">ğŸ¬ ç”µå½±å¤§ç‰‡ (Cinema)</option>
                        <option value="3d">ğŸ§¸ 3D æ¸²æŸ“ (3D)</option>
                        <option value="anime">ğŸ‡¯ğŸ‡µ åŠ¨æ¼«é£æ ¼ (Anime)</option>
                        <option value="pixel">ğŸ‘¾ åƒç´ è‰ºæœ¯ (Pixel)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸ’¡ å…‰ç…§ (Lighting)</label>
                    <select id="light-select" onchange="handleUpdate()">
                        <option value="natural">â˜€ï¸ è‡ªç„¶å…‰</option>
                        <option value="studio">ğŸ”¦ æ‘„å½±æ£šå…‰</option>
                        <option value="neon">ğŸŒƒ èµ›åšéœ“è™¹</option>
                        <option value="moon">ğŸŒ™ æœˆå…‰</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸŒ¦ï¸ å¤©æ°” (Weather)</label>
                    <select id="weather-select" onchange="handleUpdate()">
                        <option value="clear">â˜€ï¸ æ™´æœ—</option>
                        <option value="rain">ğŸŒ§ï¸ ä¸‹é›¨</option>
                        <option value="snow">â„ï¸ ä¸‹é›ª</option>
                        <option value="fog">ğŸŒ«ï¸ é›¾å¤©</option>
                    </select>
                </div>

                <div class="control-group">
                    <label class="control-label">ğŸ“· è¿é•œ (Zoom)</label>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.8rem; color:#B2BEC3;">
                        <span>ç‰¹å†™</span><span>å…¨èº«</span><span>èˆªæ‹</span>
                    </div>
                    <input type="range" id="zoom-slider" min="0" max="4" step="1" value="1" oninput="handleUpdate()">
                </div>

                <div style="background:#E3F2FD; padding:15px; border-radius:16px; display:flex; align-items:center; justify-content:space-between; border:1px solid #BBDEFB;">
                    <div>
                        <span style="font-weight:bold; color:#1565C0; display:block;">ğŸ§ª å®éªŒæ¨¡å¼ (Seed Lock)</span>
                        <span style="font-size:0.8rem; color:#1976D2;">é”å®šæ„å›¾ï¼Œåªæ¢å…ƒç´ </span>
                    </div>
                    <input type="checkbox" id="seed-lock" onchange="toggleSeedLock()" style="width:24px; height:24px; cursor:pointer; accent-color:#2196F3;">
                </div>

                <button class="magic-btn" onclick="manualSnap()">ğŸ“¸ ç‚¹å‡»æ˜¾å½± (Snap)</button>
            </div>
        </div>

        <div class="panel-right">
            <div class="viewfinder">
                <div id="loading-spinner" class="spinner">ğŸ”® æ­£åœ¨æ˜¾å½±...</div>
                <img id="preview-img" src="https://placehold.co/800x533/2d3436/FFF?text=Ready+to+Dream" alt="Preview">
            </div>

            <div class="output-box" id="prompt-result" data-raw="">ç­‰å¾…æŒ‡ä»¤ä¸­... ğŸ¤–</div>

            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="action-btn copy-btn" onclick="copyToClipboard()">ğŸ“‹ å¤åˆ¶</button>
                <button class="action-btn download-btn" onclick="downloadImage()">â¬‡ï¸ ä¸‹è½½</button>
            </div>
            
            <button class="optimize-btn" onclick="optimizePrompt()">âœ¨ é­”æ³•ä¼˜åŒ– (Magic Optimize)</button>
            <button class="save-btn" onclick="saveToGallery()">â¤ï¸ æ”¶è—è¿›ç”»å»Š (Save)</button>
        </div>
    </div>

    <div style="margin-top:60px; border-top:2px dashed #dfe6e9; padding-top:40px;">
        <h2 style="text-align:center; color:#2d3436;">ğŸ–¼ï¸ æ¢¦å¢ƒç”»å»Š</h2>
        <div id="gallery-grid" class="gallery-grid"></div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="clearGallery()" style="background:none; border:none; color:#b2bec3; cursor:pointer; text-decoration:underline;">ğŸ—‘ï¸ æ¸…ç©ºç”»å»Š</button>
        </div>
    </div>
</div>

<script>
    // --- é€»è¾‘éƒ¨åˆ† (ä¿æŒä¸å˜ï¼ŒåŠŸèƒ½æ ¸å¿ƒ) ---
    const manualData = {
        subjects: { "girl": "cyberpunk girl, neon hair", "cat": "cute tabby cat astronaut", "robot": "vintage tin robot", "wizard": "gandalf wizard", "house": "hobbit house" },
        emotions: ["crying", "neutral", "laughing", "angry", "surprised"],
        zooms: ["extreme close-up", "portrait", "medium shot", "full body", "drone view"],
        styles: { "real": "hyper-realistic, 8k", "cinema": "cinematic movie scene", "3d": "3D render", "pixel": "pixel art" },
        lightings: { "natural": "soft sunlight", "neon": "neon lights", "studio": "studio lighting", "moon": "moonlight" },
        weathers: { "clear": "clear sky", "rain": "heavy rain", "snow": "snowing", "fog": "foggy" }
    };
    
    const missions = // --- ğŸ† å‡çº§ç‰ˆé¢˜åº“ï¼š5ä¸ªå¾ªåºæ¸è¿›çš„å…³å¡ ---
    const missions = [
        { 
            id: 1, 
            title: "æ–°æ‰‹æ‘ï¼šé›¨ä¸­æ³ª", 
            desc: "è®©æˆ‘ä»¬å¼€å§‹ç¬¬ä¸€è¯¾ã€‚è¯·ç”Ÿæˆä¸€å¼ å……æ»¡æ•…äº‹æ„Ÿçš„ç…§ç‰‡ï¼š<br>åœ¨ <b>é›¨ä¸­(Rain)</b> çš„ <b>æ‚²ä¼¤(Crying)</b> çš„ <b>èµ›åšå°‘å¥³(Girl)</b>ã€‚", 
            requirements: { "subject-select": "girl", "weather-select": "rain", "emotion-slider": "0" },
            hint: "æç¤ºï¼šå…³æ³¨ä¸»è§’ã€å¤©æ°”å’Œæƒ…ç»ªæ»‘å—ã€‚"
        },
        { 
            id: 2, 
            title: "è¿›é˜¶è¯¾ï¼šå¿«ä¹å¤ªç©ºçŒ«", 
            desc: "é£æ ¼è½¬æ¢æµ‹è¯•ï¼æˆ‘ä»¬éœ€è¦ä¸€å¼  <b>æ‰‹æœºæŠ“æ‹(Real)</b> é£æ ¼çš„ç…§ç‰‡ã€‚<br>ä¸»è§’æ˜¯ä¸€åª <b>å¤§ç¬‘(Laughing)</b> çš„ <b>å®‡èˆªå‘˜çŒ«å’ª(Cat)</b>ã€‚", 
            requirements: { "style-select": "real", "subject-select": "cat", "emotion-slider": "2" },
            hint: "æç¤ºï¼šåˆ«å¿˜äº†æŠŠé£æ ¼åˆ‡æ¢å›'æ‰‹æœºæŠ“æ‹'ã€‚"
        },
        { 
            id: 3, 
            title: "å…‰å½±è¯¾ï¼šéœ“è™¹æ­¦å£«", 
            desc: "å­¦ä¹ å…‰å½±çš„ä½¿ç”¨ã€‚è¯·åˆ›ä½œä¸€ä½ <b>å¤ä»£å‰‘å®¢(Warrior)</b>ï¼Œ<br>ä»–ç«™åœ¨ <b>èµ›åšéœ“è™¹(Neon)</b> çš„ç¯å…‰ä¸‹ï¼Œä¸”è¦æ˜¯ <b>ç”µå½±å¤§ç‰‡(Cinema)</b> è´¨æ„Ÿã€‚", 
            requirements: { "subject-select": "warrior", "light-select": "neon", "style-select": "cinema" },
            hint: "æç¤ºï¼šå…‰ç…§é€‰æ‹©'èµ›åšéœ“è™¹'èƒ½å¸¦æ¥å¼ºçƒˆçš„å¯¹æ¯”ã€‚"
        },
        { 
            id: 4, 
            title: "æ„å›¾è¯¾ï¼šç‰¹å†™é­”æ³•å¸ˆ", 
            desc: "è¿é•œå†³å®šäº†ç”»é¢çš„å†²å‡»åŠ›ã€‚<br>è¯·ç»™ <b>é­”æ³•å¸ˆ(Wizard)</b> æ‹ä¸€å¼  <b>æåº¦ç‰¹å†™(Extreme Close-up)</b>ï¼Œè¦èƒ½çœ‹æ¸…ä»–çš„èƒ¡é¡»ï¼", 
            requirements: { "subject-select": "wizard", "zoom-slider": "0" },
            hint: "æç¤ºï¼šå°†è¿é•œæ»‘å—æ‹‰åˆ°æœ€å·¦è¾¹ã€‚"
        },
        { 
            id: 5, 
            title: "æ¯•ä¸šè€ƒï¼šéœæ¯”ç‰¹äººçš„é›ªæ™¯", 
            desc: "ç»¼åˆè€ƒéªŒï¼æˆ‘ä»¬éœ€è¦ä¸€å¼  <b>3Dæ¸²æŸ“(3D)</b> é£æ ¼çš„å£çº¸ã€‚<br>åœºæ™¯æ˜¯ <b>ä¸‹é›ª(Snow)</b> çš„ <b>éœæ¯”ç‰¹å°å±‹(House)</b>ï¼Œé‡‡ç”¨ <b>èˆªæ‹è§†è§’(Drone)</b>ã€‚", 
            requirements: { "subject-select": "house", "style-select": "3d", "weather-select": "snow", "zoom-slider": "4" },
            hint: "æç¤ºï¼šä½ éœ€è¦åŒæ—¶è°ƒæ•´å››ä¸ªå‚æ•°ï¼"
        }
    ];
    
    let currentLockedSeed = null; let isChallengeActive = false; let currentLevel = 0;

    // åˆå§‹åŒ–
    window.onload = function() {
        handleUpdate(); // é¡µé¢åŠ è½½æ—¶å…ˆåˆ·æ–°ä¸€æ¬¡æ–‡å­—é¢œè‰²
        renderGallery();
    };

    function handleUpdate() { 
        updateManualPrompt(); 
        if(isChallengeActive) checkMissionProgress(); 
    }
    
    function updateManualPrompt() {
        const s = document.getElementById('subject-select').value;
        const e = document.getElementById('emotion-slider').value;
        const z = document.getElementById('zoom-slider').value;
        const st = document.getElementById('style-select').value;
        const l = document.getElementById('light-select').value;
        const w = document.getElementById('weather-select').value;

        // æ„å»ºRaw
        const raw = `${manualData.styles[st]||st}, ${manualData.subjects[s]||s}, ${manualData.emotions[e]||e}, ${manualData.lightings[l]||l}, ${manualData.weathers[w]||w}, ${manualData.zooms[z]||z}, best quality.`;
        document.getElementById('prompt-result').setAttribute('data-raw', raw);
        
        // æ„å»ºé«˜äº®HTML
        const html = `
            <div style="margin-bottom:5px;"><span class="token-style">[é£æ ¼] ${st}</span></div>
            <div style="margin-bottom:5px;"><span class="token-subject">[ä¸»ä½“] ${s}</span></div>
            <div style="margin-bottom:5px;"><span class="token-emotion">[æƒ…ç»ª] ${manualData.emotions[e]}</span></div>
            <div style="margin-bottom:5px;"><span class="token-env">[å…‰ç…§] ${l}</span> <span class="token-env">[å¤©æ°”] ${w}</span></div>
            <div><span class="token-zoom">[è¿é•œ] ${manualData.zooms[z]}</span></div>
            <div class="token-base" style="margin-top:8px; opacity:0.5;">best quality, masterpiece.</div>
        `;
        document.getElementById('prompt-result').innerHTML = html;
    }

    function generateAutoPrompt() { 
        const raw = "A mystical forest spirit, glowing lights, masterpiece, 8k.";
        document.getElementById('prompt-result').setAttribute('data-raw', raw); 
        document.getElementById('prompt-result').innerHTML = `<span style="color:#a29bfe">${raw}</span>`; 
        runNanoBanana(raw); 
    }
    
    function manualSnap() { runNanoBanana(document.getElementById('prompt-result').getAttribute('data-raw')); }
    
    function runNanoBanana(prompt) {
        const img = document.getElementById('preview-img'); const spin = document.getElementById('loading-spinner');
        spin.style.display='block'; img.style.opacity='0.3';
        let seed = currentLockedSeed !== null ? currentLockedSeed : Math.floor(Math.random()*9999);
        // å¢åŠ éšæœºå‚æ•°é¿å…ç¼“å­˜
        img.src = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=800&height=533&seed=${seed}&nologo=true&t=${Date.now()}`;
        img.onload = () => { spin.style.display='none'; img.style.opacity='1'; };
    }

    function switchTab(mode) {
        document.querySelectorAll('.mode-content').forEach(d=>d.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('mission-board').style.display='none'; isChallengeActive=false;
        if(mode==='auto'){document.getElementById('auto-mode').classList.add('active');document.querySelectorAll('.tab-btn')[0].classList.add('active');}
        else{
            document.getElementById('manual-mode').classList.add('active'); 
            if(mode==='challenge'){
                document.getElementById('mission-board').style.display='block';isChallengeActive=true;loadMission(0);
                document.querySelectorAll('.tab-btn')[2].classList.add('active');
            }else{
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
            }
        }
    }

    function loadMission(idx){ 
        if(idx>=missions.length){alert("é€šå…³!");return;}
        const m=missions[idx]; document.getElementById('level-title').innerText=`Level ${m.id}`; document.getElementById('mission-desc').innerHTML=m.desc;
        checkMissionProgress();
    }
    
    function checkMissionProgress(){ 
        const m=missions[0]; 
        const list=document.getElementById('mission-checklist'); list.innerHTML="";
        let all=true; 
        for(const [k,v] of Object.entries(m.requirements)){
            const el = document.getElementById(k);
            const match = el.value === v; if(!match) all=false;
            // è·å–Label
            let label = k;
            if(el.parentElement.querySelector('label')) label = el.parentElement.querySelector('label').innerText.split(' ')[0];
            list.innerHTML += `<li style="margin-bottom:5px; color:${match?'#00b894':'#d63031'};"> ${match?'âœ…':'âŒ'} <b>${label}</b> åŒ¹é…</li>`;
        }
        if(all) {
            document.getElementById('next-level-btn').style.display='block';
            confetti({particleCount: 100, spread: 70, origin: { y: 0.6 }});
        }
    }

    function toggleSeedLock(){ const l=document.getElementById('seed-lock').checked; if(l&&!currentLockedSeed)currentLockedSeed=Math.floor(Math.random()*9999); if(!l)currentLockedSeed=null; }
    function optimizePrompt(){ 
        let raw = document.getElementById('prompt-result').getAttribute('data-raw');
        raw += ", highly detailed, dramatic lighting, 8k resolution";
        document.getElementById('prompt-result').setAttribute('data-raw', raw);
        manualSnap();
    } 
    function copyToClipboard(){ navigator.clipboard.writeText(document.getElementById('prompt-result').getAttribute('data-raw')).then(()=>alert("å·²å¤åˆ¶ï¼")); }
    function downloadImage(){ const a=document.createElement('a'); a.href=document.getElementById('preview-img').src; a.download='dream.webp'; a.click(); }
    
    function saveToGallery(){ 
        const u=document.getElementById('preview-img').src; 
        const p=document.getElementById('prompt-result').innerText;
        const g=document.getElementById('gallery-grid'); 
        // æœ¬åœ°å­˜å‚¨é€»è¾‘å¯åœ¨æ­¤æ‰©å±•
        g.innerHTML=`<div class="gallery-card"><div class="card-inner"><div class="card-front"><img src="${u}"></div><div class="card-back">${p.substring(0,50)}...</div></div></div>` + g.innerHTML; 
    }
    function clearGallery(){ document.getElementById('gallery-grid').innerHTML=""; }
    
    // åˆå§‹æ¸²æŸ“ç”»å»Š
    function renderGallery() {} 
</script>
</body>
</html>
